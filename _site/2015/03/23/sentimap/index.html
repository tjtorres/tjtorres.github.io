<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="This blog details my data science and data visualization projects and thoughts.">

    <title>Inside SentiMap.us: Part 1 - Random Projections</title>

    <link rel="canonical" href="localhost:4000/2015/03/23/sentimap/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61079460-1', 'auto');
  ga('send', 'pageview');

</script>
</head>



<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Random Projections</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/sentimap.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Inside SentiMap.us: Part 1</h1>
                    
                    <h2 class="subheading">A Pythonic How-To on Twitter Sentiment</h2>
                    
                    <span class="meta">Posted by TJ Torres on March 23, 2015</span>
                </div>
            </div>
        </div>
    </div>

</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1">

				<h1>Introduction</h1>

<p>This is the first in a series of planned posts describing the building of my web app project <a href="http://sentimap.us">SentiMap.us</a>. The basic premise behind SentiMap is to plot localized trends in mood via realtime sentiment analysis of a geotagged Twitter stream. This post will focus mainly on the backend sentiment analysis portion of the project and take you through streaming tweets, feature extraction, and classification. However, if you get impatient waiting for future posts, the full code is available on <a href="https://github.com/tjtorres/SentiMap">GitHub</a> for you to peruse at your leisure.</p>

<p>Without getting too far into the details just yet, the main functionality behind the sentiment classification, in this case, comes from vectorizing tweets via Word2Vec to construct tweet feature vectors and then training a random forest classifier on a <a href="http://help.sentiment140.com/for-students">pre-classified tweet corpus</a>. We will cover each of these topics in greater detail later, but for now let&#39;s focus on the setup.</p>

<p>The entirety of the coding for the first post will be in python, and will use the following libraries:</p>

<ul>
<li><a href="https://github.com/tweepy/tweepy">Tweepy</a> (Python library for dealing with the Twitter API)</li>
<li><a href="http://www.nltk.org">NLTK</a> (Natural Language Toolkit used for stopwords)</li>
<li><a href="https://radimrehurek.com/gensim/">gensim</a> (Python library containing Word2Vec algorithm)</li>
<li><a href="http://pandas.pydata.org">Pandas</a> (for managing the Tweet training corpus)</li>
<li><a href="http://scikit-learn.org/stable/">Scikit-Learn</a> (providing machine learning functionality)</li>
</ul>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">pip install tweepy nltk gensim pandas sklearn
</code></pre></div>
<p>Note that in order to use NLTK&#39;s stop word corpus you must first download it via</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span><span class="kn">import</span> <span class="nn">nltk</span>
<span class="o">&gt;&gt;&gt;</span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
</code></pre></div>
<p>With that out of the way, the basic flow follows two main lines:</p>

<h4>Training the Classifier</h4>

<ol>
<li>Load the GoogleNews pre-trained Word2Vec vectors. </li>
<li>Import and format/clean the Sentiment140 Twitter Corpus.</li>
<li>Vectorize the training data tweets.</li>
<li>Train a classifier on the cleaned corpus data (I chose a Random Forest).</li>
</ol>

<h4>Predicting Tweet Sentiment From Stream</h4>

<ol>
<li>Grab JSON formatted output from the Stream endpoint of the Twitter API</li>
<li>Strip/clean tweet text.</li>
<li>Vectorize cleaned tweet.</li>
<li>Predict sentiment and store data in database.</li>
</ol>

<h2>Representing Words as Vectors</h2>

<p>We&#39;ll start out by training a machine learning classifier to predict tweet sentiment. The general methodology behind any classification scheme is to take a dataset and transform each data point into a vector that, we hope, represents its most salient features with respect to the task at hand. This process of feature extraction can be nearly trivial for some applications, but in general it represents a substantive obstacle with no unique solution. </p>

<p>In the case of natural language processing (NLP), the process of feature extraction for use in sentiment analysis is particularly ill-defined. When we, as people, parse a sentence or phrase we can draw upon years of past experience and contextual clues from countless interactions with language to determine whether said phrase is generally positive, negative, or neutral. For instance, most people would generally decide that the sentence &quot;He is not the brightest crayon in the box.&quot; is reasonably negative. However, without the idiomatic context, the phrase itself might be viewed as merely neutral. </p>

<p>Additionally, taking this lack of context to the extreme we might consider the same phrase where even the order of words (that is the contextual clues in the the text itself) were beyond our knowledge. Or perhaps in it&#39;s ultimate manifestation, the ordering of letters and characters. It&#39;s easy to see the difficulty in deciding anything, other than perhaps letter frequency, about a phrase that has been deconstructed so completely. Yet this is somewhat akin to the world that machines inhabit, having no previous knowledge of language context beyond syntactic rules for translating code documents into binary. </p>

<p>Thus, while there are certainly more naive approaches to constructing vector representations of documents, the big challenge is then to construct systems which simulate the process of learning contextual knowledge. To that end, we will focus on a system of algorithms, called Word2Vec, designed to extract context clues for specific words via the analysis of massive datasets of text. </p>

<p>As much as I&#39;d love to speak a bit about how Word2Vec works (perhaps a future blog post) in gritty technical detail, for now I will point you to a <a href="http://technology.stitchfix.com/blog/2015/03/11/word-is-worth-a-thousand-vectors/">blog post written by a friend of mine</a> which is quite accessible to the lay-person, but contains a large number of technical links at the bottom for those who wish to delve further. Suffice it to say here that Word2Vec &quot;learns&quot; N-dimensional vector representations of words by analyzing and associating words that are less than a certain distance from them in the corpus of training text. At the end of the day we want two words to have vectors that are &quot;close&quot; to each other when it is probabilistically favorable for them to be near each other in a system of documents. For example, a decent metric for determining the &quot;closeness&quot; of vectors is the angle between them which can be easily obtained through use of the inner (or dot) product. Consequently, one might expect that &quot;lion&quot; and &quot;giraffe&quot; are often mentioned within close proximity to one another and thus the angle between their vector representations should be close to zero. </p>

<p>Given the amount of text needed to train these models, it is often advantageous to use large corpuses of words with their pre-trained vectors representations. As the original implementation of Word2Vec was invented by a Google engineer, the codebase, as well as <a href="https://drive.google.com/file/d/0B7XkCwpI5KDYNlNUTTlSS21pQmM/edit?usp=sharing">pre-trained vector sets</a> can be found on their site <a href="https://code.google.com/p/word2vec/">here</a>. For this example we will use their vectors that have been trained on GoogleNews stories. </p>

<p>Since our vectors are pre-trained we will just need to load the binary file into gensim&#39;s Word2Vec implementation. Vectors for given words are then easily accessible by using the word strings as keys on our model instance. Then we will construct a function to take a string with only letters and whitespace and remove common words of little contextual meaning, called stop words, then output a vector based on the average of the set of vectors that correspond to words in the string.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">gensim</span> <span class="kn">as</span> <span class="nn">gs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>

<span class="n">stop_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s">&quot;english&quot;</span><span class="p">))</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Word2Vec</span><span class="o">.</span><span class="n">load_word2vec_format</span><span class="p">(</span><span class="s">&#39;./GoogleNews-vectors-negative300.bin&#39;</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">phrase2vec</span><span class="p">(</span><span class="n">phrase</span><span class="p">):</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">phrase_fil</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">phrase</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">stop_set</span><span class="p">]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">phrase_fil</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">model</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>
            <span class="n">size</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
</code></pre></div>
<p>We now have a nice function for vectorizing tweets, once they have been properly formatted.</p>

<h2>Cleaning the Data</h2>

<p>Next, we&#39;ll need to get some training data to run our feature extraction method on. Though there are several Twitter sentiment corpora on the web, many of them sacrifice sample size for accuracy of classification of the training set. Since we are dealing with the potentially very powerful, but somewhat nebulous, concept of word vectors we should choose instead to err on the side of a much larger training set, with perhaps a slight hit to classification accuracy. This can be accomplished by creating heuristics for classification rather than relying on manual techniques. The <a href="http://help.sentiment140.com/for-students/">Sentiment 140 Corpus</a> constructs its sentiment classification heuristic on tweets that contain emoticons. Of the tweets that contain emoticons, those that contain mostly positive emoticons are classified as such, and the same goes for the negative set. </p>

<p>With this heuristic one can immediately automate the data classification task for the training set, which allows for a far greater sample size (in this case 1.6M tweets), at the expense of a possible drop in accuracy. </p>

<p>To analyze and clean our data we&#39;re going to work with Pandas, but first let&#39;s take a brief look at the format of the training data.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$head</span> -10 training.1600000.processed.noemoticon.csv

<span class="s2">&quot;0&quot;</span>,<span class="s2">&quot;1467810369&quot;</span>,<span class="s2">&quot;Mon Apr 06 22:19:45 PDT 2009&quot;</span>,<span class="s2">&quot;NO_QUERY&quot;</span>,<span class="s2">&quot;_TheSpecialOne_&quot;</span>,<span class="s2">&quot;@switchfoot http://twitpic.com/2y1zl - Awww, that&#39;s a bummer.  You shoulda got David Carr of Third Day to do it. ;D&quot;</span>
<span class="s2">&quot;0&quot;</span>,<span class="s2">&quot;1467810672&quot;</span>,<span class="s2">&quot;Mon Apr 06 22:19:49 PDT 2009&quot;</span>,<span class="s2">&quot;NO_QUERY&quot;</span>,<span class="s2">&quot;scotthamilton&quot;</span>,<span class="s2">&quot;is upset that he can&#39;t update his Facebook by texting it... and might cry as a result  School today also. Blah!&quot;</span>
<span class="s2">&quot;0&quot;</span>,<span class="s2">&quot;1467810917&quot;</span>,<span class="s2">&quot;Mon Apr 06 22:19:53 PDT 2009&quot;</span>,<span class="s2">&quot;NO_QUERY&quot;</span>,<span class="s2">&quot;mattycus&quot;</span>,<span class="s2">&quot;@Kenichan I dived many times for the ball. Managed to save 50%  The rest go out of bounds&quot;</span>
<span class="s2">&quot;0&quot;</span>,<span class="s2">&quot;1467811184&quot;</span>,<span class="s2">&quot;Mon Apr 06 22:19:57 PDT 2009&quot;</span>,<span class="s2">&quot;NO_QUERY&quot;</span>,<span class="s2">&quot;ElleCTF&quot;</span>,<span class="s2">&quot;my whole body feels itchy and like its on fire &quot;</span>
<span class="err">$</span>
</code></pre></div>
<p>From the first few lines you can see the general format of the data and should notice several things. For instance the training data file doesn&#39;t have a header, so we&#39;ll have to name the columns ourselves. Also, the text of the tweets has been formatted to remove emoticons, but still contains plenty of errant strings like URLs and @name tags we&#39;ll need to remove before proceeding to vectorize them. </p>

<p>First let&#39;s import the csv file and store it as a dataframe.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sentiment&#39;</span><span class="p">,</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;query&#39;</span><span class="p">,</span><span class="s">&#39;user&#39;</span><span class="p">,</span><span class="s">&#39;text&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">&quot;training.1600000.processed.noemoticon.csv&quot;</span><span class="p">,</span>\
                 <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span> <span class="n">name_list</span><span class="p">)</span>
</code></pre></div>
<p>Now we&#39;ll create a function that takes a string and strips it down to only the text content we care about, removing URLs, names, emoji character sets, and &quot;#&quot; part of the hashtags. We can also optimize our data to be more uniform by taking repeated instances of letters, as in the string &quot;loooooooooove&quot;, and transforming them down to 2 at most. This is best accomplished using python&#39;s regular expressions module. I&#39;ll construct the function here, keeping things a bit more long form for the sake of readability. </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">re</span>

<span class="c">#compile regular expressions that match repeated characters and emoji unicode</span>
<span class="n">emoji</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">u&#39;[^</span><span class="se">\x00</span><span class="s">-</span><span class="se">\x7F\x80</span><span class="s">-</span><span class="se">\xFF\u0100</span><span class="s">-</span><span class="se">\u017F\u0180</span><span class="s">-</span><span class="se">\u024F\u1E00</span><span class="s">-</span><span class="se">\u1EFF</span><span class="s">]&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">multiple</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(.)\1{1,}&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">tweet</span><span class="p">):</span>

    <span class="c">#strip emoji</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">emoji</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">elem</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">])</span>

    <span class="c">#strip URLs</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;http[s]?[^\s]+&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip &quot;@name&quot; components</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;(@[A-Za-z0-9\_]+)&#39;</span> <span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">,</span><span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip html &#39;&amp;amp;&#39;, &#39;&amp;lt;&#39;, etc.  </span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[\&amp;].*;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip punctuation</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[#|\!|\-|\+|:|//]&#39;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip the common &quot;RT&quot;</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s">&#39;RT.&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip whitespace down to one.</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;[\s]+&#39;</span> <span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c">#strip multiple occurrences of letters</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">multiple</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;\1\1&quot;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span>

    <span class="c">#strip all non-latin characters</span>
    <span class="c">#if we wish to deal with foreign language tweets, we would need to first </span>
    <span class="c">#translate them before taking this step.</span>

    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;[^a-zA-Z0-9|</span><span class="se">\&#39;</span><span class="s">]&#39;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stripped</span>
</code></pre></div>
<p>Take a look at <a href="https://docs.python.org/2/howto/regex.html">Python&#39;s RegEx HOW-TO</a> if you&#39;re confused on the above format. You can also test them out yourself by visiting <a href="http://regexr.com">Regexr</a>.</p>

<h2>Training the Classifier</h2>

<p>Now we&#39;re ready to train our classifier. Let&#39;s start off by making an array of feature vectors for our training data, as well as an array of target values for the sentiment. </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#initialize a numpy array to the proper shape and a counter. </span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">300</span><span class="p">))</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">#add vectorized tweet text to numpy array.</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>

    <span class="n">filtered</span> <span class="o">=</span> <span class="n">format</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="n">vectorized</span> <span class="o">=</span> <span class="n">phrase2vec</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
    <span class="n">training_data</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">vectorized</span>
    <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">training_target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</code></pre></div>
<p>Now we simply pick which ML algorithm we wish to train. In this case I will be using a random forest classifier. Once we train our model we can then easily export the results using scikit-learn&#39;s joblib function, which operates on Python&#39;s Pickle package (say that 5 times fast) to dump our Python classifier model to a file.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.externals</span> <span class="kn">import</span> <span class="n">joblib</span>

<span class="n">cl</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>

<span class="n">cl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="n">training_target</span><span class="p">)</span>

<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s">&#39;Pickle/rfc.pkl&#39;</span><span class="p">)</span>
</code></pre></div>
<p>That&#39;s basically it for training. So far we have trained and exported a classifier to use in the future for predicting tweet sentiment. At this point it would normally be necessary to validate the model via the method of your choice. Scikit-learn has some nice cross-validation functionality for just this purpose, or you can grab the test data from the same Sentiment 140 folder and begin your testing metrics. For simple classification tasks like this I find F-scores to be rather useful. Also you should note that we have only used the default configured random forest classifier here, and there are many options with which to performance optimize your individual setup.</p>

<h2>Streaming and Predicting Tweets</h2>

<p>Now that we have a model, we can move to predicting a tweet stream in realtime. In order to start streaming tweets, we&#39;ll use a nice Python package called Tweepy, which interfaces with the Twitter API and allows us to focus our attention on the task at hand rather than dealing with Oauth validation. You will need to get some credentials before we can start, so head over to <a href="https://apps.twitter.com">Twitter&#39;s application page</a> and register your own &quot;app&quot; to receive access credentials. </p>

<p>Once you&#39;ve got your credentials and installed the Tweepy we can proceed to setting up a streaming client. In this example I&#39;ll set one up that outputs the sentiment-valued stream to file. First we need to construct a <code>Listener</code> class that inherits from<code>tweepy.streaming.StreamListener</code>. We&#39;ll also be handling JSON, so we need to import Python&#39;s JSON module as well. We will use the on_data method to perform a task every time we receive a tweet. </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">tweepy.streaming</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">OAuthHandler</span>
<span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">Stream</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>




<span class="k">def</span> <span class="nf">get_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">stop</span> <span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">trained_classifier</span><span class="p">):</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">trained_classifier</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">phrase2vec</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">model</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">vec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pred</span>


<span class="k">class</span> <span class="nc">Listener</span><span class="p">(</span><span class="n">StreamListener</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">stops</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">start</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>



    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c">#parse json from data event</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./Data/{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
            <span class="n">tweet</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span>  <span class="s">&#39;en&#39;</span> <span class="ow">or</span> <span class="n">elem</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span>  <span class="s">&#39;en-gb&#39;</span><span class="p">:</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="n">format</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>


                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sentiment</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl</span><span class="p">)</span>

                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span> <span class="p">[</span><span class="n">tweet</span><span class="p">,</span>
                                      <span class="n">filtered</span><span class="p">,</span>
                                      <span class="n">sentiment</span><span class="p">,</span>
                                      <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()])</span>





        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mf">3600.</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Time&#39;s Up!&quot;</span>
            <span class="k">return</span> <span class="bp">False</span>



    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">status</span>
</code></pre></div>
<p>This class then takes incoming tweets and writes them to a file specified as the first argument. The second argument is reserved for the time (in hours) one wishes to keep the stream alive. You can easily edit this to continue indefinitely if desired. </p>

<p>From here on in we must merely load in models and setup the stream with our credentials.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c">####################Variables that contain the user credentials for the Twitter API </span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="s">&quot;ACCESS_TOKEN&quot;</span>
    <span class="n">access_token_secret</span> <span class="o">=</span> <span class="s">&quot;ACCESS_TOKEN_SECRET&quot;</span>
    <span class="n">consumer_key</span> <span class="o">=</span> <span class="s">&quot;CONSUMER_KEY&quot;</span>
    <span class="n">consumer_secret</span> <span class="o">=</span> <span class="s">&quot;CONSUMER_SECRET&quot;</span>
    <span class="c">#########################################################</span>

    <span class="c">#Write file header</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;./Data/{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;original_text,filtered_output,sentiment,time </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">print</span> <span class="s">&quot;Loading Classifier...</span><span class="se">\n\n</span><span class="s">&quot;</span>

    <span class="c">#load trained sklearn classifier</span>
    <span class="n">cl</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;Pickle/rfc.pkl&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&quot;Classifier Loaded...loading model...</span><span class="se">\n\n</span><span class="s">&quot;</span>

    <span class="c">#load w2v vectors from GoogleNews training set. </span>
    <span class="n">model</span><span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Word2Vec</span><span class="o">.</span><span class="n">load_word2vec_format</span><span class="p">(</span>
           <span class="s">&#39;./static/Data/GoogleNews-vectors-negative300.bin&#39;</span><span class="p">,</span><span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">print</span> <span class="s">&quot;Model Loaded...</span><span class="se">\n\n</span><span class="s">&quot;</span>

    <span class="c">#load set of stop words</span>
    <span class="n">stop_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s">&quot;english&quot;</span><span class="p">))</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">Listener</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">stop_set</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">start</span><span class="p">)</span>

    <span class="c">#This handles Twitter authentication and the connection to Twitter Streaming API</span>

    <span class="c">#Oauth Handling</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">OAuthHandler</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Listening...&quot;</span>

    <span class="c">#initiate stream</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</code></pre></div>
<p>When we run the file <code>python path_to_script.py output_file_name time</code> we should then see our file being populated with tweets and their corresponding sentiments.</p>

<h1>More to Come</h1>

<p>This concludes the first post on SentiMap.us. Hopefully you&#39;ve gained a basic understanding of the nuts and bolts behind realtime sentiment analysis for twitter streams. </p>

<p>In the next post we will cover using MongoDB to hold fixed size collections of tweets, setting up a basic web server using Flask, and serving out data to servers using the PubSub messaging queue paradigm. </p>


                <hr>

                <ul class="pager">
                    
                    
                </ul>

            </div>
        </div>
    </div>
<div id="disqus_thread" class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'orthogonalprojections';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/tjtorres">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Random Projections 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
